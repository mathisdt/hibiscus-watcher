when:
  - event: [push, manual]

clone:
  - name: clone
    image: woodpeckerci/plugin-git
    settings:
      depth: 0
      partial: false
      recursive: true

steps:
  - name: build
    when:
      - event: [ push, manual ]
    depends_on: []
    image: maven:3.9-eclipse-temurin-25-alpine
    commands: |
      export TZ=Europe/Berlin
      mvn clean verify -U --no-transfer-progress
  - name: release on Codeberg
    when:
      - event: manual
        branch: [ master, main ]
    depends_on: [ build ]
    image: codeberg.org/mathisdt/releaseplugin:latest
    pull: true
    settings:
      TOKEN:
        from_secret: TOKEN_REPO_READWRITE
      PATTERN_TO_RELEASE: 'target/hibiscus-watcher-*.zip'
  - name: mirror to Github
    when:
      - event: [ push, manual ]
        branch: [ master, main ]
    depends_on: []
    image: codeberg.org/mathisdt/buildhelper:latest
    pull: true
    environment:
      TOKEN_GITHUB:
        from_secret: TOKEN_GITHUB
    commands: |
      git remote add github https://mathisdt:$TOKEN_GITHUB@github.com/mathisdt/$CI_REPO_NAME.git
      git push github
